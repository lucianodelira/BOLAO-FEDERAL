<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sala do BolÃ£o - Loteria Federal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#fff; }
.hidden { display:none; }
.container { max-width:380px; margin:40px auto; background:#111; padding:22px; border-radius:14px; }
h2,h3 { text-align:center; margin-top:0; }
input, button { width:100%; padding:12px; margin-top:10px; border-radius:8px; border:none; font-size:15px; }
input { background:#1e1e1e; color:#fff; }
button { background:#00e676; color:#000; font-weight:bold; cursor:pointer; }
.status { margin-top:10px; text-align:center; }
.qr img { width:220px; margin-top:10px; }
.pixkey { background:#1c1c1c; padding:8px; border-radius:6px; margin-top:6px; word-break:break-all; font-size:13px; }
.sala { max-width:800px; margin:auto; padding:20px; }
.card { background:#121212; border-radius:12px; padding:16px; margin-bottom:15px; }
ul { padding-left:18px; margin-top:10px; }
ul li { background:#1e1e1e; padding:8px; border-radius:6px; margin-bottom:6px; font-size:14px; }
#puleContainer { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
</style>
</head>
<body>

<!-- LOGIN / PIX -->
<div class="container" id="loginArea">
  <h2>ğŸŸï¸ BolÃ£o Loteria Federal</h2>
  <input id="nome" placeholder="Seu nome completo">
  <input id="telefone" placeholder="Telefone / WhatsApp">
  <button onclick="gerarPix()">GERAR PIX</button>
  <div class="status" id="status"></div>
  <div class="qr" id="qr"></div>
</div>

<!-- SALA -->
<div class="sala hidden" id="salaBolao">
  <h2>ğŸ‰ Sala do BolÃ£o</h2>

  <div class="card">
    <h3>ğŸ‘¤ Seus dados</h3>
    <p><strong>Nome:</strong> <span id="meuNome"></span></p>
    <p><strong>Telefone:</strong> <span id="meuTelefone"></span></p>
  </div>

  <div class="card">
    <h3>ğŸ‘¥ Participantes do BolÃ£o</h3>
    <button onclick="toggleParticipantes()" style="margin-bottom:10px">Ver participantes</button>
    <ul id="listaParticipantes" class="hidden"></ul>
  </div>

  <h3>ğŸ¯ Pule do BolÃ£o</h3>
  <button onclick="gerarPule()" style="margin-bottom:10px">Gerar Pule</button>
  <div id="puleContainer" class="hidden"></div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyyFITAR_NOlCc1zNuML7omJrSZje84pWC9e5zu0-5DNxnmoVcSkHyYzHJujcfC_VzZ/exec';

let paymentId = null;
let timer = null;
let nomeCliente = '';
let telefoneCliente = '';

/* ================= AUTO LOGIN ================= */
const auth = JSON.parse(localStorage.getItem('bolao_auth'));
if (auth && auth.expires > Date.now()) {
  entrarNaSala(auth.nome, auth.telefone);
}

/* ================= PIX ================= */
function gerarPix() {
  nomeCliente = nome.value.trim();
  telefoneCliente = telefone.value.trim();

  if (!nomeCliente || !telefoneCliente) {
    status.innerText = 'Preencha todos os dados';
    return;
  }

  status.innerText = 'Gerando PIX...';

  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'createPayment',
      nome: nomeCliente,
      telefone: telefoneCliente
    })
  })
  .then(r => r.json())
  .then(data => {
    if (!data.success) {
      status.innerText = data.message;
      return;
    }

    paymentId = data.paymentId;

    qr.innerHTML = `
      <img src="data:image/png;base64,${data.qrCodeBase64}">
      <div class="pixkey">${data.pixKey}</div>
    `;

    status.innerText = 'â³ Aguardando pagamento...';
    timer = setInterval(verificarPagamento, 5000);
  });
}

function verificarPagamento() {
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'checkPayment',
      paymentId
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.status === 'PAID') {
      clearInterval(timer);

      localStorage.setItem('bolao_auth', JSON.stringify({
        nome: nomeCliente,
        telefone: telefoneCliente,
        expires: Date.now() + (24 * 60 * 60 * 1000) // 24 horas
      }));

      entrarNaSala(nomeCliente, telefoneCliente);
    }
  });
}

/* ================= SALA ================= */
function entrarNaSala(nome, telefone) {
  loginArea.classList.add('hidden');
  salaBolao.classList.remove('hidden');

  meuNome.innerText = nome;
  meuTelefone.innerText = telefone;

  carregarParticipantes();
}

function carregarParticipantes() {
  fetch(API_URL + '?action=infoBolao')
    .then(r => r.json())
    .then(data => {
      listaParticipantes.innerHTML = '';
      data.participantes.forEach(p => {
        const li = document.createElement('li');
        li.textContent = p.nome;
        listaParticipantes.appendChild(li);
      });
    });
}

function toggleParticipantes(){
  const ul = document.getElementById('listaParticipantes');
  ul.classList.toggle('hidden');
}

/* ================= PULE ================= */
function gerarPule() {
  const div = document.getElementById('puleContainer');
  div.classList.remove('hidden');
  div.innerHTML = 'Gerando pule...';

  fetch(`${API_URL}?action=getPule`)
    .then(r => r.json())
    .then(data => {
      div.innerHTML = '';
      if (!data.success) {
        div.innerHTML = `<p>${data.message}</p>`;
        return;
      }

      const { numeros, codigo } = data;

      // CartÃ£o da PULE preenchido automaticamente
      const card = document.createElement('div');
      card.style.background = '#1e1e1e';
      card.style.padding = '12px';
      card.style.borderRadius = '8px';
      card.style.gridColumn = '1 / -1';
      card.style.fontSize = '14px';
      card.style.lineHeight = '1.5';

      card.innerHTML = `
        <strong>ğŸŸï¸ PULE DO BOLÃƒO</strong><br><br>
        ğŸ‘¤ Nome: ${nomeCliente}<br>
        ğŸ“ Telefone: ${telefoneCliente}<br>
        ğŸ” CÃ³digo de SeguranÃ§a: <strong>${codigo}</strong><br><br>
        ğŸ¯ NÃºmeros:<br>
        ${numeros.join(', ')}
      `;

      div.appendChild(card);

      // BotÃ£o para compartilhar no WhatsApp
      const btn = document.createElement('button');
      btn.textContent = 'Compartilhar no WhatsApp';
      btn.style.marginTop = '8px';
      btn.onclick = () => compartilharPule(codigo, numeros);
      card.appendChild(btn);
    });
}



/* ================= COMPARTILHAR ================= */
function compartilharPule(codigo, numeros) {
  const texto = `
ğŸŸï¸ MINHA PULE DO BOLÃƒO
ğŸ‘¤ Nome: ${nomeCliente}
ğŸ“ Telefone: ${telefoneCliente}
ğŸ” CÃ³digo: ${codigo}
ğŸ¯ NÃºmeros:
${numeros.join(', ')}
  `;

  window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`, '_blank');
}


// Auto login pelo localStorage
if(localStorage.getItem('bolao_nome') && localStorage.getItem('bolao_telefone')){
  nomeCliente = localStorage.getItem('bolao_nome');
  telefoneCliente = localStorage.getItem('bolao_telefone');
  entrarNaSala(nomeCliente, telefoneCliente);
}
</script>

</body>
</html>
